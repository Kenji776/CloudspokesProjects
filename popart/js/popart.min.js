var pictureRecords={},userData={},imageData={},attachmentId,contestId,numpics=0,canvas,context,picasaMailAddr="105399981347341202435.66sword2527@picasaweb.com",picasaUrl="https://picasaweb.google.com/105399981347341202435/DropBox";
$(document).ready(function(){$("input:submit, input:button, button","#submitControls,#picasaShare,#uploadNoticeBox, #sharePanel").button();loader(!0);$.cookie("artMashUser")!=null?(userData=jQuery.parseJSON($.cookie("artMashUser")),$("#submitterName").val(userData.name),$("#submitterEmail").val(userData.email)):(userData.email="",userData.name="",writeCookie());$("#submitConfirm").dialog({autoOpen:!1,modal:!0,close:function(){$("#submitControls").show();$("#progressbar").hide();$("#resultsMessage").hide();
$("#sharePanel").hide()}});$("#shareOnPicasa").dialog({autoOpen:!1});$("#uploadNoticeBox").dialog({autoOpen:!1});$("#progressbar").progressbar({value:10});canvas=document.getElementById("pictureCanvas");context=canvas.getContext("2d");loadContestList()});function registerSlider(){$("div#makeMeScrollable").smoothDivScroll({})}
function loadContestList(){artMashExtensions.getContests(function(a,c){if(c.status)console.log(a.sObjects[0]),contestId=a.sObjects[0].Id,picasaMailAddr=a.sObjects[0].Picasa_Dropbox_Email__c,picasaUrl=a.sObjects[0].Picasa_Dropbox_URL__c,loadPictures(contestId)},{escape:!0})}
function loadPictures(a){artMashExtensions.getPictures(a,function(a,d){if(d.status){pictureRecords=a.sObjectMap;numpics=a.sObjects.length;for(var b=0,e=a.sObjects.length;b<e;++b)getPictureBody(a.sObjects[b].Current_Picture_Document_Id__c,a.sObjects[b].Id,function(a,c,b){$("#imageGallery").append("<img  onClick=\"setImage('"+b+"','"+c+'\',true);" width="148" class="thmbImage" height="127" id="X'+b+'" src="data:image/png;base64,'+a+'"/>');$("#X"+b).mouseover(function(){$(this).effect("bounce",{times:3,
distance:15},300)});setDefaultImage()})}},{escape:!0})}function setDefaultImage(){numImages=$("#imageGallery img").length;numImages>0&&loadContent()}function loadContent(){for(picture in pictureRecords){setImage(pictureRecords[picture].Id,!0);break}}function getPictureBody(a,c,d){a in imageData?d(imageData[a],a,c):artMashExtensions.getDocumentFileBody(a,function(b,e){e.status&&(imageData[a]=b,d(b,a,c))},{escape:!0})}
function setImage(a,c,d){loader(!0);thisPic=pictureRecords[a];$("#pictureId").val(thisPic.Id);a=document.getElementById("X"+a);if(a!=null){var b=a.naturalHeight;canvas.width=a.naturalWidth;canvas.height=b;context.drawImage(a,0,0);context.font=thisPic.Font_Size__c+"px "+thisPic.Font_Family__c;context.fillStyle=thisPic.Text_Color__c;if(c)d=thisPic.Default_Text__c;c=getLines(context,d,thisPic.Text_Box_Width__c,context.font);d=parseInt(thisPic.Text_Box_Top_Offset__c)+parseInt(thisPic.Font_Size__c,10);
for(i=0;i<c.length;i++)context.fillText(c[i],thisPic.Text_Box_Left_Offset__c,d),d=parseInt(d,10)+parseInt(thisPic.Font_Size__c,10)+2}loader(!1)}function getLines(a,c,d,b){var c=c.split(" "),e=[],f="",h=0;a.font=b;for(b=0;b<c.length;b++){var g=c[b],h=a.measureText(f+g).width;h<d?f+=" "+g:(e.push(f),f=g);if(b===c.length-1){e.push(f);break}}return e}
function submitCaption(){$("#progressbar").show();$("#submitControls").hide();userData.name=$("#submitterName").val();userData.email=$("#submitterEmail").val();writeCookie();$("#progressbar").progressbar("value",15);var a=$("#captionForm").serialize();a+="&";a+=$("#userDataForm").serialize();console.log(a);a=a+"&img="+canvas.toDataURL();$("#progressbar").progressbar("value",25);artMashExtensions.createCaption(a,function(a,d){$("#progressbar").progressbar("value",75);if(d.status)attachmentId=a.data,
$("#progressbar").progressbar("value",100),$("#progressbar").hide(),a.success=="true"||a.success==!0?($("#resultsMessage").html('<p>Your artwork has been uploaded to the Appirio Pop Art Gallery! Click <a href="'+picasaUrl+'" target="_blank">here</a> to check out all of the submissions.<p>'),$("#sharePanel").show(),uploadPicasa()):(console.log(a),$("#resultsMessage").html("<p>Hm, there was an error posting your caption. Please try again later.</p>"),$("#sharePanel").hide())},{escape:!0});$("#progressbar").progressbar("value",
50)}function uploadPicasa(){console.log("uploading to"+picasaMailAddr);artMashExtensions.SendToPicasa(attachmentId,picasaMailAddr,function(a,c){$("#progressbar").progressbar("value",75);c.status&&console.log(a)},{escape:!0})}function writeCookie(){var a=JSON.stringify(userData);$.cookie("artMashUser",a,{expires:7})}
function trimCaption(a){a.length>pictureRecords[$("#pictureId").val()].Maximum_Caption_Length__c&&(a=a.substring(0,pictureRecords[$("#pictureId").val()].Maximum_Caption_Length__c));$("#captionText").val(a)}function loader(a){a?($("#pictureCanvas").hide(),$("#loader").show()):($("#pictureCanvas").show(),$("#loader").hide())};