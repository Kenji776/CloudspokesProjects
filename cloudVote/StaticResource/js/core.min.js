var proposalData={},userData={};userLoggedIn=false;var pageLog=[],pageIndex=0,siteUrl="{!siteUrl}",pageName="{!pageName}";function getUrlVars(){for(var a=[],c,e=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),d=0;d<e.length;d++)c=e[d].split("="),a.push(c[0]),a[c[0]]=c[1];return a}
function loadCategoriesList(){$.mobile.showPageLoadingMsg();cloudVote.getCategories("{!config.id}",function(a,c){if(c.status){for(var e='<ul data-role="listview" data-theme="{!config.jQuery_Mobile_List_Theme__c}" data-filter="true">',d="",b=0;b<a.length;b++)e+='<li><span class="ui-li-count">'+a[b].Number_of_Proposals__c+"</span><a href=\"javascript:loadProposalList('"+a[b].Id+"');\">"+a[b].Name+"</a><li><p>"+a[b].Description__c+"</p></li></li>",d+='<option value="'+a[b].Id+'">'+a[b].Name+"</option>";
e+="</ul>";$("#categoryList").html(e);$("#proposalCategoryInput").html(d);try{$("#categories").page("destroy").page()}catch(f){}}else document.getElementById("responseErrors").innerHTML=c.message},{escape:true});$.mobile.hidePageLoadingMsg()}
function addComment(){var a=$("#addCommentInput").val();cloudVote.addComment(proposalData.Id,userData.Id,a,function(c,e){e.status?getComments(proposalData.Id,function(c){$("#commentsContianer").html(null);for(var b='<ul data-role="listview" data-theme="{!config.jQuery_Mobile_List_Theme__c}">',a=0;a<c.length;a++)b+='<li data-role="list-divider">'+c[a].Contact__r.FirstName+" "+c[a].Contact__r.LastName+"</li><li><p>"+c[a].Comment__c+"</p></li>";b+="</ul>";$("#commentsContianer").html(b);$("#proposal").page("destroy").page()}):
document.getElementById("responseErrors").innerHTML=e.message;a=$("#addCommentInput").val(null)},{escape:true})}
function loadProposalList(a){$.mobile.showPageLoadingMsg();cloudVote.getProposals(a,function(c,a){if(a.status){for(var d='<ul data-role="listview" data-theme="{!config.jQuery_Mobile_List_Theme__c}" data-filter="true">',b=0;b<c.length;b++)d+='<li><span class="ui-li-count">'+c[b].Score__c+"</span><a href=\"javascript:getProposal('"+c[b].Id+"');\">"+c[b].Name+"</a> <li><p>"+c[b].Description__c+"</p> <p>Created By "+c[b].Contact__r.FirstName+" "+c[b].Contact__r.LastName+"</p></li> </li>";c.length==0&&
(d+="<li>No Proposals in this category</li>");d+="</ul>";$("#proposalList").html(d);$.mobile.changePage("#proposals");$("#proposals").page("destroy").page()}else document.getElementById("responseErrors").innerHTML=a.message},{escape:true});$.mobile.hidePageLoadingMsg()}
function getProposal(a){var c;$.mobile.showPageLoadingMsg();$("#promoteButton").addClass("ui-disabled");$("#demoteButton").addClass("ui-disabled");cloudVote.getProposal(a,function(a,d){if(d.status){var b=a[0];proposalData=b;$.mobile.changePage("#proposal",{transition:"pop"});$("#proposalHeader").html(b.Name);$("#proposalDescription").html(b.Description__c);$("#proposalCreatedBy").html(b.Contact__r.FirstName+" "+b.Contact__r.LastName);$("#proposalScore").html(b.Score__c);getVotes(proposalData.Id,function(a){$("#voterImages").html(null);
c=false;for(var b=0;b<a.length;b++)a[b].Contact__c==userData.Id&&(c=true),$("#voterImages").append('<img src=" http://graph.facebook.com/'+a[b].Contact__r.Facebook_ID__c+'/picture" title="'+a[b].Contact__r.FirstName+" "+a[b].Contact__r.LastName+'" style="float:left; margin-left:3px">');userLoggedIn==true&&c==false&&($("#promoteButton").removeClass("ui-disabled"),$("#demoteButton").removeClass("ui-disabled"))});getComments(proposalData.Id,function(a){$("#commentsContianer").html(null);for(var c='<ul data-role="listview" data-theme="{!config.jQuery_Mobile_List_Theme__c}">',
b=0;b<a.length;b++)c+='<li data-role="list-divider">'+a[b].Contact__r.FirstName+" "+a[b].Contact__r.LastName+"</li><li><p>"+a[b].Comment__c+"</p></li>";c+="</ul>";$("#commentsContianer").html(c);$("#proposal").page("destroy").page()})}else document.getElementById("responseErrors").innerHTML=d.message;$.mobile.hidePageLoadingMsg()},{escape:true})}
function fb_login(){window.open("https://www.facebook.com/dialog/oauth?client_id={!config.Facebook_App_ID__c}&redirect_uri=http://{!$Site.Domain}{!$Site.Prefix}/cv_fb_regFinish&scope=user_about_me,user_birthday,email,offline_access,publish_stream","mywindow","status=0,toolbar=0,width=1000,height=550,menubar=0")}function getVotes(a,c){cloudVote.getVotes(a,function(a,d){d.status?c(a):c(d.message)},{escape:true})}
function getComments(a,c){cloudVote.getComments(a,function(a,d){d.status?c(a):c(d.message)},{escape:true})}function castProposalVote(a){$.mobile.showPageLoadingMsg();cloudVote.castVote(proposalData.Id,userData.Id,a,function(a,e){e.status?getProposal(proposalData.Id):document.getElementById("responseErrors").innerHTML=e.message;$.mobile.hidePageLoadingMsg()},{escape:true})}
function shareProposal(){$.mobile.showPageLoadingMsg();cloudVote.sharePropOnFB(proposalData.Id,userData.Id,function(a,c){c.status?$.mobile.changePage("#propShared",{transition:"pop",role:"dialog"}):document.getElementById("responseErrors").innerHTML=c.message;$.mobile.hidePageLoadingMsg()},{escape:true})}
function createProposal(){$.mobile.showPageLoadingMsg();$("#submitProposal").addClass("ui-disabled");var a=$("#proposalNameInput").val(),c=$("#proposalCategoryInput").val(),e=$("#proposalDescriptionInput").val();cloudVote.createProposal(c,userData.Id,a,e,function(a,b){b.status?($.mobile.changePage("#propCreated",{transition:"pop",role:"dialog"}),$("#proposalNameInput").val(null),$("#proposalCategoryInput").val(null),$("#proposalDescriptionInput").val(null)):document.getElementById("responseErrors").innerHTML=
b.message;$("#submitProposal").removeClass("ui-disabled");$.mobile.hidePageLoadingMsg()},{escape:true})}
$(document).ready(function(){checkFBLoginStatus();loadCategoriesList();$("#categories").live("pageshow",function(){loadCategoriesList()});$("#proposal").live("pageshow",function(){proposalData.hasOwnProperty("Id")||$.mobile.changePage("#home")});$("#add").live("pageshow",function(){userData.hasOwnProperty("Id")?$("#submitProposal").removeClass("ui-disabled"):$("#submitProposal").addClass("ui-disabled")});$("#home").live("pagecreate",function(){getUrlVars().prop!=null&&getProposal(getUrlVars().prop)});
$(".foot").html(" <div id='responseErrors'></div><div class='ui-body-{!config.jQuery_Mobile_NavBar_Theme__c}'><nav data-role='navbar'><ul  ><li><a href='#categories' data-icon='home'>Proposals</a></li><li><a href='#login' data-icon='star'>Login</a></li><li><a href='#about' data-icon='info'>About</a></li><li><a href='#add' data-icon='plus'>Add</a></li></ul></nav></div>")});
function checkFBLoginStatus(){var a=$.cookie("{!config.Application_Name__c}_fb");a==null?($("#connectFBDone").hide(),$("#connectFB").show(),userLoggedIn=false):(userData=jQuery.parseJSON(a),$("#connectFB").hide(),$("#connectFBDone").show(),userLoggedIn=true);try{$("#login").page("destroy").page()}catch(c){}};